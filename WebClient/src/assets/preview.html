<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Preview</title>
  <style>
    /* Basic Reset & Body Styles */
    body {
      margin: 0;
      font-family: var(--main-font-fam, sans-serif); /* Default font */
      background-color: var(--third-color, #ffffff); /* Default background */
      color: var(--alt-color, #333333); /* Default text color */
      transition: background-color 0.3s, color 0.3s;
      padding: 10px; /* Add some padding */
    }

    /* Placeholder for Store Container */
    .store-preview-content {
      max-width: 1200px;
      margin: 0 auto;
      border: 1px dashed #ccc;
      padding: 20px;
      min-height: 500px;
    }

    /* Base styles for components (can be customized further) */
    .store-component {
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      background-color: #f8f9fa; /* Default component background */
      display: none; /* Hidden by default */
    }

    /* Specific component placeholder styles */
    #header { background-color: var(--main-color, #eee); color: var(--alt-color, #333); }
    #hero { background-color: var(--second-color, #ddd); color: var(--alt-color, #333); min-height: 150px; }
    #featured { background-color: #fff; border: 1px solid var(--third-color, #eee); }
    #categories { background-color: #fff; border: 1px solid var(--third-color, #eee); }
    #testimonials { background-color: var(--third-color, #f0f0f0); }
    #newsletter { background-color: var(--main-color, #eee); color: var(--alt-color, #333); }
    #footer { background-color: var(--main-color, #333); color: var(--third-color, #ccc); font-size: 0.9em; }

    /* Example styling using theme vars */
    h1, h2, h3 {
      font-family: var(--main-font-fam, sans-serif);
      color: var(--main-color, #333); /* Use main color for headings */
    }

    #header h1 { color: inherit; } /* Inherit color from header */
    #hero h2 { color: inherit; }
    #newsletter h3 { color: inherit; }
    #footer p { color: inherit; }

    button {
      background-color: var(--second-color, blue);
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }

  </style>
</head>
<body>
  <div class="store-preview-content">
    <!-- Component Placeholders -->
    <div id="header" class="store-component">
      <h1 id="store-name-preview">Store Name</h1>
      <p>Navigation Placeholder</p>
    </div>
    <div id="hero" class="store-component">
      <h2 id="banner-text-preview">Hero Banner Text</h2>
      <p>Call to action area.</p>
    </div>
    <div id="featured" class="store-component">
      <h3>Featured Products</h3>
      <p>Product grid/list placeholder.</p>
    </div>
    <div id="categories" class="store-component">
      <h3>Category Showcase</h3>
      <p>Category grid/list placeholder.</p>
    </div>
    <div id="testimonials" class="store-component">
      <h3>Testimonials</h3>
      <p>"This store is great!" - A Customer</p>
    </div>
    <div id="newsletter" class="store-component">
      <h3>Newsletter Signup</h3>
      <input type="email" placeholder="Enter your email">
      <button>Subscribe</button>
    </div>
    <div id="footer" class="store-component">
      <p>&copy; <span id="footer-store-name">Store Name</span>. All rights reserved.</p>
    </div>
  </div>

  <script>
    const knownComponentSelectors = {
      'header': '#header',
      'hero': '#hero',
      'featured': '#featured',
      'categories': '#categories',
      'testimonials': '#testimonials',
      'newsletter': '#newsletter',
      'footer': '#footer'
    };

    function applyTheme(theme) {
      const root = document.documentElement;
      if (!theme) {
        console.log("No theme data received, using defaults.");
        // Clear theme overrides if needed, or rely on CSS defaults
        root.style.removeProperty('--main-color');
        root.style.removeProperty('--second-color');
        root.style.removeProperty('--third-color');
        root.style.removeProperty('--alt-color');
        root.style.removeProperty('--main-font-fam');
        return;
      }
      console.log("Applying theme:", theme);
      root.style.setProperty('--main-color', theme.mainColor || '#393727');
      root.style.setProperty('--second-color', theme.secondColor || '#D0933D');
      root.style.setProperty('--third-color', theme.thirdColor || '#D3CEBB');
      root.style.setProperty('--alt-color', theme.altColor || '#333333');
      root.style.setProperty('--main-font-fam', theme.mainFontFam || 'sans-serif');
    }

    function updateComponents(selectedComponents) {
      console.log("Updating components:", selectedComponents);
      const showAll = !selectedComponents || selectedComponents.length === 0; // Check if we should show all

      // Hide all components first, unless we intend to show all
      if (!showAll) {
        Object.values(knownComponentSelectors).forEach(selector => {
          const elem = document.querySelector(selector);
          if (elem) elem.style.display = 'none';
        });
      }

      // Show selected components or all components
      if (showAll) {
        console.log("No component selection received or selection is empty, showing all components.");
        Object.values(knownComponentSelectors).forEach(selector => {
          const elem = document.querySelector(selector);
          if (elem) elem.style.display = 'block'; // Show the component
        });
      } else if (Array.isArray(selectedComponents)) {
        selectedComponents.forEach(componentId => {
          const selector = knownComponentSelectors[componentId];
          if (selector) {
            const elem = document.querySelector(selector);
            if (elem) elem.style.display = 'block';
          }
        });
      }
    }

    function updateContent(storeData) {
      if (!storeData) {
        console.log("No store data received for content update.");
        return;
      }
      console.log("Updating content with store data:", storeData);
      
      const storeNameElem = document.getElementById('store-name-preview');
      if (storeNameElem) storeNameElem.textContent = storeData.name || 'Store Name';

      const bannerTextElem = document.getElementById('banner-text-preview');
      if (bannerTextElem) bannerTextElem.textContent = storeData.bannerText || 'Hero Banner Text';

      const footerStoreNameElem = document.getElementById('footer-store-name');
      if (footerStoreNameElem) footerStoreNameElem.textContent = storeData.name || 'Store Name';
      
      // TODO: Add more content updates based on storeData as needed
      // (e.g., populating product placeholders, categories, etc.)
    }

    function handleMessage(event) {
      // IMPORTANT: Verify the origin in production!
      // if (event.origin !== 'YOUR_ANGULAR_APP_ORIGIN') {
      //   console.warn('Message received from unexpected origin:', event.origin);
      //   return;
      // }

      const data = event.data;
      console.log("Message received in preview:", data);

      if (data && data.type === 'updatePreview') {
        applyTheme(data.theme);
        updateComponents(data.components);
        updateContent(data.storeData);
      } else if (data && data.type === 'updateComponents') {
         // Handle legacy message type from StoreEditor if needed (optional)
         console.log("Handling legacy 'updateComponents' message");
         updateComponents(data.components);
         updateContent(data.storeData);
      }
       else {
        console.log("Received message of unknown type or format");
      }
    }

    window.addEventListener('message', handleMessage);

    console.log("Preview iframe script loaded and listening for messages.");

  </script>
</body>
</html> 